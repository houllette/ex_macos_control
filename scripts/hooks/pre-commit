#!/bin/bash
# Pre-commit hook for ExMacOSControl
# Ensures code quality before commits

set -e  # Exit on first error

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

echo ""
echo "ğŸ” Running pre-commit checks..."
echo ""

# 1. Check if mix.lock is up to date
echo "ğŸ“¦ Checking mix.lock is up to date..."
if ! mix deps.get --check-locked 2>/dev/null; then
  echo -e "${RED}âŒ mix.lock is out of date!${NC}"
  echo -e "${YELLOW}Run 'mix deps.get' to update dependencies${NC}"
  exit 1
fi
echo -e "${GREEN}âœ… mix.lock is up to date${NC}"
echo ""

# 2. Run mix quality (format check, credo, dialyzer)
echo "ğŸ”§ Running mix quality checks..."
if ! mix quality; then
  echo -e "${RED}âŒ Quality checks failed!${NC}"
  echo -e "${YELLOW}Fix the issues above before committing${NC}"
  exit 1
fi
echo -e "${GREEN}âœ… All quality checks passed${NC}"
echo ""

# 3. Generate SBOM
echo "ğŸ“‹ Generating SBOM (Software Bill of Materials)..."
if ! mix sbom.cyclonedx -d; then
  echo -e "${RED}âŒ SBOM generation failed!${NC}"
  echo -e "${YELLOW}Check sbom errors above${NC}"
  exit 1
fi
echo -e "${GREEN}âœ… SBOM generated successfully${NC}"
echo ""

# 4. Check if SBOM file was generated and stage it
if [ -f "sbom.cyclonedx.json" ]; then
  echo "ğŸ“ Staging sbom.cyclonedx.json..."
  git add sbom.cyclonedx.json
  echo -e "${GREEN}âœ… SBOM file staged${NC}"
elif [ -f "priv/sbom.cyclonedx.json" ]; then
  echo "ğŸ“ Staging priv/sbom.cyclonedx.json..."
  git add priv/sbom.cyclonedx.json
  echo -e "${GREEN}âœ… SBOM file staged${NC}"
else
  echo -e "${YELLOW}âš ï¸  No SBOM file found to stage${NC}"
fi
echo ""

echo -e "${GREEN}ğŸ‰ All pre-commit checks passed!${NC}"
echo ""

exit 0
